<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

    <link rel="stylesheet" href="/src/styles/main.css"/>
    <link rel="stylesheet" href="./src/styles/toast.css">

    <title>Tauri App</title>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
          integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A=="
          crossorigin="anonymous" referrerpolicy="no-referrer"/>

    <script type="module" src="/src/Main.js" defer></script>
    <script type="module" src="/src/calendar/CalendarUtil.ts" defer></script>
</head>

<body class="poppins-regular">
<div class="notifications"></div>
<div class="calendar-container">
    <div class="calendar-header">
        <h2 id="month-year"></h2>
    </div>
    <div class="calendar-body">
        <div class="month-nav">
            <button id="prev-month-btn" class="prev-month">Prev</button>
            <button id="next-month-btn">Next</button>
        </div>
        <div class="day-of-week">
            <div>Mon</div>
            <div>Tue</div>
            <div>Wed</div>
            <div>Thu</div>
            <div>Fri</div>
            <div>Sat</div>
            <div>Sun</div>
        </div>
        <div id="calendar-dates"></div>
    </div>
</div>
<div>
    <button id="logout-btn">Log out</button>
    <select id="select-calendar">
        <option value="">Please select...</option>
    </select>
    <button id="create-calendar-btn">New Calendar</button>
    <button id="edit-calendar-btn">Edit Calendar</button>
</div>
<!-- The Modal -->
<div id="create-calendar-modal" class="modal">
    <!-- Modal content -->
    <div class="modal-content">
        <div class="">
            <span class="close-btn">&times;</span>
            <h2>Create a new calendar</h2>
        </div>
        <form id="create-calendar-form">
            <div>
                <label id="label-new-calendar-name" for="new-calendar-name">Calendar name</label>
                <input id="new-calendar-name" type="text" placeholder="Gustav"/>
            </div>
            <div>
                <div class="flex">
                    <h3>Users</h3>
                    <form id="add-users-form">
                        <button id="add-new-user-btn" type="submit">Add user</button>
                        <input id="add-new-calendar-user" type="text" placeholder="User email"/>
                    </form>
                </div>
                <div id="calendar-users">
                </div>
            </div>
            <button id="store-new-calendar-btn" type="submit">Create</button>
        </form>
    </div>
</div>

<!-- The Edit Modal -->
<div id="edit-calendar-modal" class="modal">
    <!-- Modal content -->
    <div class="modal-content">
        <div class="">
            <span class="close-btn">&times;</span>
            <h2>Edit calendar</h2>
        </div>
        <form id="edit-calendar-form">
            <div>
                <label id="label-calendar-name" for="edit-calendar-name">Calendar name</label>
                <input id="edit-calendar-name" type="text" placeholder="Gustav"/>
            </div>
            <div>
                <div class="flex">
                    <h3>Users</h3>
                    <form id="edit-add-users-form">
                        <button id="edit-add-new-user-btn" type="submit">Add user</button>
                        <input id="edit-add-new-calendar-user" type="text" placeholder="User email"/>
                    </form>
                </div>
            </div>
            <button id="store-edited-calendar-btn" type="submit">Create</button>
        </form>
    </div>
</div>

<script type="module">
    import {invoke} from "@tauri-apps/api/core";
    import {createErrorToast, createInfoToast} from "./src/Toast.ts";
    import {invalidateJwtCookie} from "./src/controller/AuthController.js";

    document.getElementById("logout-btn").onclick = logout;
    const calendarUserList = document.getElementById("calendar-users");

    async function logout() {
        await invoke("logout", {
            token: document.cookie.split("=")[1],
        }).catch((e) => createErrorToast(e));

        invalidateJwtCookie();
        window.location.reload();
    }

    document.getElementById("store-new-calendar-btn").onclick = async function(event) {
        event.preventDefault();
        const name = document.getElementById("new-calendar-name").value;
        const usersElements = document.getElementById("calendar-users").children;
        const users = getEmailsOfCalendarUsers(usersElements);

        await invoke("store_new_calendar", {
            calendarName: name,
            usersEmails: users,
        });

        document.getElementById("create-calendar-modal").style.display = "none";

        await loadUserCalendarData()
    }

    document.getElementById("add-new-user-btn").onclick = async function (event) {
        event.preventDefault();
        const userEmail = document.getElementById("add-new-calendar-user").value;

        if (getEmailsOfCalendarUsers(calendarUserList.children).includes(userEmail)) {
            return;
        }

        let userExists = false;

        await invoke("user_exists", {email: userEmail})
            .then((res) => {
                userExists = res;
            })
            .catch((err) => {
                createErrorToast(err);
            });

        if (!userExists) {
            return;
        }

        appendUserToList(userEmail);
    };

    function appendUserToList(email) {
        const calendarUserCount = calendarUserList.children.length;
        const newUserElement = document.createElement("div");
        const htmlParagraphElement = document.createElement("p");
        htmlParagraphElement.textContent = email;
        newUserElement.setAttribute("id", "calendar-user-" + calendarUserCount + 1);
        newUserElement.setAttribute("class", "calendar-user");
        newUserElement.appendChild(htmlParagraphElement);
        calendarUserList.appendChild(newUserElement);
    }

    function getEmailsOfCalendarUsers(calendarUserList) {
        const users = [];
        let i = 0;
        while (i < calendarUserList.length) {
            const userElement = calendarUserList[i];
            users.push(userElement.children[0].textContent);
            i++;
        }
        return users;
    }
</script>
<script type="module" src="/src/Toast.ts" defer></script>
</body>
</html>
